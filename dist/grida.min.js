!function(){var a,b,c,d,e,f,g,h,i,j,k={}.hasOwnProperty,l=function(a,b){function c(){this.constructor=a}for(var d in b)k.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};b=$(window),a=$(document),g=function(){function b(){this.onMouseMove=function(){}}return b.prototype.record=function(b){return this.onMouseMove=function(a){return b(a)},a.mousemove(this.onMouseMove)},b.prototype.stopRecording=function(){return a.unbind("mousemove",this.onMouseMove)},b}(),c=function(){function a(a){this.el=$(a).get(0),this.mousePos=new g,this.setCssAbsolute(),this.initEvents()}return a.create=function(b,c){return c?new i(b,c):new a(b)},a.prototype.setCssAbsolute=function(){var a,b;return a=this.el,b=$(a).position(),a.style.position="absolute",a.style.left=b.left+"px",a.style.top=b.top+"px"},a.prototype.initEvents=function(){var a,b=this;return a=$(this.el),a.mouseup(function(c){return a.trigger("xxx-draggable-mouseup",[c]),b.mousePos.stopRecording()}),$(this.el).mousedown(function(c){return a.trigger("xxx-draggable-mousedown",[c]),b.mousePos.record(b.getMousemoveCB(c.pageX,c.pageY)),!1})},a.prototype.getMousemoveCB=function(a,b){var c,d,e,f;return c=this.el,d=$(c).position(),e=a-d.left,f=b-d.top,function(a){return c.style.left=a.pageX-e+"px",c.style.top=a.pageY-f+"px"}},a}(),i=function(a){function b(a,c){this.grid=c,b.__super__.constructor.call(this,a)}return l(b,a),b.prototype.getMousemoveCB=function(a,b){var c,d,e,f,g,h,i,j;return d=this.el,c=$(d),e=this.grid,h=Math.round,g=c.position(),i=a-g.left,j=b-g.top,f=h(e.topToRowUnit(g.top))+"x"+h(e.leftToColUnit(g.left)),function(a){var b,g,k,l;return g=a.pageX-i,l=a.pageY-j,k=h(e.topToRowUnit(l)),b=h(e.leftToColUnit(g)),k+"x"+b!==f&&(c.trigger("xxx-draggable-snap",[k,b]),f=k+"x"+b),d.style.left=g+"px",d.style.top=l+"px"}},b}(c),h=function(){function b(a){this.el=$(a).get(0),this.mousePos=new g,this.addHandle(),this.initEvents()}return b.create=function(a,c){var d,e;return null==c&&(c={}),d=c.grid,e=c.margin,d?new j(a,d.x,d.y,e.x,e.y):new b(a)},b.prototype.addHandle=function(){return $(this.el).append('<div class="xxx-handle-se"></div>')},b.prototype.initEvents=function(){var b=this;return a.mouseup(function(){return b.mousePos.stopRecording()}),$(this.el).children(".xxx-handle-se").mousedown(function(a){return a.stopPropagation(),b.mousePos.record(b.getMousemoveCB(a.pageX,a.pageY)),!1})},b.prototype.getMousemoveCB=function(a,b){var c,d,e,f;return d=this.el,c=$(d),e=a-c.width(),f=b-c.height(),function(a){return d.style.width=a.pageX-e+"px",d.style.height=a.pageY-f+"px"}},b}(),j=function(a){function b(a,c,d,e,f){this.gridx=c,this.gridy=d,this.marginx=e,this.marginy=f,b.__super__.constructor.call(this,a)}return l(b,a),b.prototype.getMousemoveCB=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;return d=this.el,c=$(d),i=this.marginx,j=this.marginy,e=this.gridx,g=this.gridy,f=e/2,h=g/2,l=a-c.width(),m=b-c.height(),k=0,function(a){var b,n,o,p;return p=a.pageX-l,b=a.pageY-m,n=p%e,o=b%g,n>=f?p+=e-n:p-=n,o>=h?b+=g-o:b-=o,p+=(Math.floor(p/e)-1)*i,b+=(Math.floor(b/g)-1)*j,k!==p+b&&(c.trigger("xxx-resizable-snap",[p,b]),k=p+b),d.style.width=p+"px",d.style.height=b+"px"}},b}(h),f={TRADE:1,SHIFT_DOWN:2},d=function(){function a(a,b,c,d,e){this.containerEl=a,this.gridx=b,this.gridy=c,this.marginx=null!=d?d:0,this.marginy=null!=e?e:0,this.maxCol=0,this.grid=[],this.members=[],this.updateMaxCol(),this.updateOffsetLeft(),this.initEvents()}return a.prototype.initEvents=function(){var a=this;return b.resize(function(){var b,c,d,e,f;for(a.updateMaxCol(),a.updateOffsetLeft(),a.grid=[],e=a.members,f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(a.append(b));return f})},a.prototype.topToRowUnit=function(a){return(a-this.marginy)/(this.marginy+this.gridy)},a.prototype.leftToColUnit=function(a){return(a-this.offsetLeft-this.marginx)/(this.marginx+this.gridx)},a.prototype.rowUnitToTop=function(a){return(a+1)*this.marginy+a*this.gridy},a.prototype.colUnitToLeft=function(a){return(a+1)*this.marginx+a*this.gridx+this.offsetLeft},a.prototype.sizeToWidth=function(a){return a*this.gridx+(a-1)*this.marginx},a.prototype.sizeToHeight=function(a){return a*this.gridy+(a-1)*this.marginy},a.prototype.widthToSize=function(a){return(a-this.marginx)/(this.marginx+this.gridx)},a.prototype.heightToSize=function(a){return(a-this.marginy)/(this.marginy+this.gridy)},a.prototype.updateMaxCol=function(){var a;return a=$(this.containerEl).width(),this.maxCol=Math.floor(this.widthToSize(a))-1,this.maxCol<0?this.maxCol=0:void 0},a.prototype.updateOffsetLeft=function(){var a,b,c;return a=$(this.containerEl).width(),c=this.maxCol+1,b=this.marginx+c*(this.gridx+this.marginx),this.offsetLeft=(a-b)/2},a.prototype.get=function(a,b){return this.grid[a]?this.grid[a][b]:null},a.prototype.set=function(a,b,c){var d,e,f,g,h,i;for(i=[],f=g=0,h=a.sizey;h>=0?h>g:g>h;f=h>=0?++g:--g)d=b+f,this.grid[d]||(this.grid[d]=[]),i.push(function(){var b,f,g;for(g=[],e=b=0,f=a.sizex;f>=0?f>b:b>f;e=f>=0?++b:--b)g.push(this.grid[d][c+e]=a);return g}.call(this));return i},a.prototype.remove=function(a){var b,c,d,e,f,g;if(null!==a.row){for(g=[],d=e=0,f=a.sizey;f>=0?f>e:e>f;d=f>=0?++e:--e)b=a.row+d,g.push(function(){var d,e,f;for(f=[],c=d=0,e=a.sizex;e>=0?e>d:d>e;c=e>=0?++d:--d)this.get(b,a.col+c)===a?f.push(delete this.grid[b][a.col+c]):f.push(void 0);return f}.call(this));return g}},a.prototype.isSpaceFree=function(a,b,c,d){var e,f,g,h;for(f=g=0;d>=0?d>g:g>d;f=d>=0?++g:--g)for(e=h=0;c>=0?c>h:h>c;e=c>=0?++h:--h)if(this.get(a+f,b+e))return!1;return!0},a.prototype.getMembersAt=function(a,b,c,d,e){var f,g,h,i,j,k;for(null==e&&(e={}),i=j=0;d>=0?d>j:j>d;i=d>=0?++j:--j)for(g=a+i,h=k=0;c>=0?c>k:k>c;h=c>=0?++k:--k)f=this.get(g,b+h),f&&(e[f.id]=f);return e},a.prototype.isInsertionPossibleAt=function(a,b,c){var d,e,g,h,i,j,k;if(i=a.sizex,j=a.sizey,h=c+(i-1),0>c||0>b||h>this.maxCol)return!1;if(0===b)return f.SHIFT_DOWN;g=this.getMembersAt(b,c,i,j);for(k in g)if(e=g[k],e.sizey===b-a.row)return f.TRADE;d=this.getMembersAt(b-1,c,i,1),delete d[a.id];for(k in g)e=g[k],delete d[e.id];return $.isEmptyObject(d)?!1:f.SHIFT_DOWN},a.prototype.insertAt=function(a,b,c){var d,e,f,g,h,i;this.remove(a),h=this.getMembersAt(b,c,a.sizex,a.sizey),d={};for(i in h)if(g=h[i],!d[g.id]){d=g.getInfluencingMembersBelow(),d[g.id]=g,f=b-g.row+a.sizey;for(i in d)e=d[i],this.remove(e);for(i in d)e=d[i],this.set(e,e.row+f,e.col),e.moveTo(e.row+f,e.col)}return this.set(a,b,c),a.moveTo(b,c)},a.prototype.append=function(a,b,c){var d,e,f;return null==b&&(b=0),null==c&&(c=0),e=a.sizex,f=a.sizey,d=c+(e-1),d>this.maxCol?e>this.maxCol+1&&this.isSpaceFree(b,c,e,f)?this.insertAt(a,b,0):this.append(a,b+1,0):this.isSpaceFree(b,c,e,f)?this.insertAt(a,b,c):this.append(a,b,c+1)},a.prototype.addElement=function(a){var b;return b=new e(this,a),this.members.push(b),this.append(b)},a}(),e=function(){function a(a,c){var d;this.grid=a,this.el=c,d=$(c),this.id=b++,this.$ghost=null,this.row=null,this.col=null,this.sizex=d.data("xxx-sizex")||1,this.sizey=d.data("xxx-sizey")||1,this.resizeTo(this.sizex,this.sizey),this.initEvents()}var b;return b=1,a.prototype.initEvents=function(){var a,b=this;return a=$(this.el),a.on("xxx-draggable-mousedown",function(){return console.log("down"),b.$ghost=a.clone().css({zIndex:-1,opacity:.2,backgroundColor:"blue"}),b.$ghost.appendTo(a.parent())}),a.on("xxx-draggable-mouseup",function(){return console.log("up"),b.$ghost&&(b.$ghost.remove(),b.$ghost=null),b.el.style.top=b.grid.rowUnitToTop(b.row)+"px",b.el.style.left=b.grid.colUnitToLeft(b.col)+"px"}),a.on("xxx-draggable-snap",function(a,c,d){var e,g,h,i;switch(console.log(c,d),console.log(!!b.grid.isInsertionPossibleAt(b,c,d)),g=b.getInfluencingMembersBelow({},!1),b.grid.isInsertionPossibleAt(b,c,d)){case f.TRADE:console.log("trade"),b.grid.remove(b);for(h in g)e=g[h],e.sizey===c-b.row&&(b.grid.remove(e),b.grid.set(e,b.row,e.col),e.moveTo(b.row,e.col));return b.grid.insertAt(b,c,d);case f.SHIFT_DOWN:console.log("shift down"),b.grid.insertAt(b,c,d),i=[];for(h in g)e=g[h],i.push(e.collapseAboveWhiteSpace());return i}})},a.prototype.collapseAboveWhiteSpace=function(a){var b,c,d,e,f,g,h;for(null==a&&(a=!0),e=this.grid,c=a?this.getInfluencingMembersBelow({},!1):{},d=0,b=this.row-1;b>=0&&$.isEmptyObject(e.getMembersAt(b,this.col,this.sizex,1));)d+=1,b=this.row-1-d;d>0&&(console.log(this.id),e.remove(this),e.set(this,this.row-d,this.col),this.moveTo(this.row-d,this.col)),h=[];for(g in c)f=c[g],h.push(f.collapseAboveWhiteSpace(!0));return h},a.prototype.getInfluencingMembersBelow=function(a,b){var c,d,e,f,g;for(null==a&&(a={}),null==b&&(b=!0),d=this.row+this.sizey,e=f=0,g=this.sizex;g>=0?g>f:f>g;e=g>=0?++f:--f)c=this.grid.get(d,this.col+e),c&&(a[c.id]=c,b&&c.getInfluencingMembersBelow(a));return a},a.prototype.moveTo=function(a,b){var c,d;return this.row=a,this.col=b,d=this.grid.rowUnitToTop(a)+"px",c=this.grid.colUnitToLeft(b)+"px",this.el.style.top=d,this.el.style.left=c,this.$ghost?this.$ghost.css({top:d,left:c}):void 0},a.prototype.resizeTo=function(a,b){return this.sizex=a,this.sizey=b,this.el.style.width=this.grid.sizeToWidth(a)+"px",this.el.style.height=this.grid.sizeToHeight(b)+"px"},a}(),$.fn.grida=function(a){var b,e,f,g,h,i,j,k,l;for(f=new d(this.get(),a.grid.x,a.grid.y,a.margin.x,a.margin.y),b=this.children().get().reverse(),g=0,i=b.length;i>g;g++)e=b[g],c.create(e,f);for(k=b.reverse(),l=[],h=0,j=k.length;j>h;h++)e=k[h],l.push(f.addElement(e));return l}}.call(this);